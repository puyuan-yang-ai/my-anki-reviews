# 深度简历优化 - 对话接口 (Converse) 功能规格

## 1. 🎯 核心思路

### 概述

深度简历优化对话接口是一个**多轮对话式信息挖掘服务**，通过模拟"职业培训师/长辈"与学生的对话，挖掘学生的个人优点和潜力，为后续简历生成收集素材。

### 解决的问题

- **目标用户**：只有基础个人信息（姓名、学历、专业等），但没有完整简历的学生
- **核心痛点**：学生不知道如何挖掘自己的亮点，无法写出有价值的简历内容
- **解决方式**：AI 以温和鼓励的语气，通过结构化的对话引导，挖掘学生的项目经历、技能特长、职业规划等信息

### 与 Generate 接口的关系

- `converse` = 信息收集阶段（多轮对话，挖掘素材）
- `generate` = 简历生成阶段（一次性调用，汇总提炼）
- 两个接口**完全独立**，不涉及相互调用。对话结束后，由前端主动调用 `generate` 接口

---

## 2. 📋 核心功能

### 输入

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `user_profile` | UserProfile | ✅ | 用户基本档案信息（姓名、学历、专业、求职期望等） |
| `history` | List[ChatMessage] | ✅ | 到目前为止的对话历史（首次调用为空数组） |
| `user_message` | string | ✅ | 用户本轮的最新回复 |
| `conversation_plan` | dict \| null | ❌ | 对话计划（首次调用为空，后续由前端透传） |

### 输出

流式 SSE 响应，包含以下事件类型：

| 事件类型 | 说明 |
|----------|------|
| `{"type": "chunk", "content": "..."}` | AI 回复的文本片段（流式输出） |
| `{"type": "DONE", "content": "[DONE]"}` | 文本流结束标志 |
| `{"type": "plan", "content": {...}}` | 对话计划（仅首次调用返回） |
| `{"type": "over", "content": "over"}` | 对话结束信号（前端收到后可调用 generate） |

### 处理逻辑

```
请求进入
    │
    ▼
┌─────────────────────────────┐
│ 预处理：沉默检测             │
│ - 检查最近3轮是否有效回复    │
│ - 3次无效 → 强制结束         │
└─────────────────────────────┘
    │
    ▼
┌─────────────────────────────┐
│ 判断：是否首次调用？         │
│ (conversation_plan 为空?)   │
└─────────────────────────────┘
    │
    ├── YES ──▶ 模块1：生成对话计划 → 返回开场白 + plan
    │
    ▼ NO
┌─────────────────────────────┐
│ 模块2：对话策略生成          │
│ 输入：history + message + plan │
│ 输出：下一步策略             │
└─────────────────────────────┘
    │
    ▼
┌─────────────────────────────┐
│ 模块3：对话执行              │
│ 输入：策略                   │
│ 输出：AI回复（流式）         │
└─────────────────────────────┘
    │
    ▼
┌─────────────────────────────┐
│ 模块4：意图识别              │
│ 判断当前动作类型             │
│ （新问题/追问/案例分析等）   │
└─────────────────────────────┘
    │
    ▼
┌─────────────────────────────┐
│ 模块5：结束判断              │
│ AI是否表达结束意图？         │
│ 是 → 返回 over 信号          │
└─────────────────────────────┘
```

---

## 3. 💻 核心实现

### 文件结构

```
project_code/career/code/
├── routers/
│   └── resume_router.py              # 路由层，定义 /resume/deep-optimization/converse 接口
├── service/
│   └── deep_resume_converse.py       # 服务层，核心对话逻辑（新建）
└── prompts/
    └── deep_resume/                  # Prompt 文件目录（新建）
        ├── generate_plan.txt         # 对话计划生成 prompt
        ├── strategy.txt              # 对话策略 prompt
        ├── executor.txt              # 对话执行 prompt
        └── judge_end.txt             # 结束判断 prompt
```

### 核心流程

**步骤1：沉默检测**
- 遍历 `history` 最后 3 条 user 消息
- 若连续 3 条为空/无效（如 `""`、`"..."`、`"嗯"`），返回结束消息并附带 `over` 信号

**步骤2：判断是否首次调用**
- 检查 `conversation_plan` 是否为空
- 若为空，进入步骤3；否则跳到步骤4

**步骤3：生成对话计划（仅首次）**
- 调用 LLM，输入 `user_profile`
- 生成包含多个阶段的对话计划（开场破冰 → 专业探索 → 经历挖掘 → 案例分析 → 职业规划 → 收尾）
- 返回开场白 + `plan` 事件

**步骤4：对话策略生成**
- 调用 LLM，输入 `history` + `user_message` + `conversation_plan`
- 输出下一步策略：追问细节 / 切换话题 / 案例分析 / 准备结束

**步骤5：对话执行**
- 调用 LLM（流式），输入策略 + `history`
- 以温和鼓励的语气生成 AI 回复
- 流式返回 `chunk` 事件

**步骤6：意图识别**
- 调用 LLM（快速模型），分析 AI 回复的动作类型
- 动作类型：`new_question` | `follow_up` | `case_analysis` | `check_status` | `end`
- 用于日志记录和状态观测

**步骤7：结束判断**
- 调用 LLM（快速模型），判断 AI 回复是否表达结束意图
- 若是，返回 `{"type": "over", "content": "over"}`
- 前端收到 `over` 后，可主动调用 `generate` 接口

---

## 4. 🌐 API 接口

**POST** `/resume/deep-optimization/converse`

流式 SSE 接口，用于深度简历优化的多轮对话。

### 请求

```json
{
  "user_profile": {
    "name": "张三",
    "birth_date": "2001-05-15",
    "gender": "男",
    "education": {
      "school_name": "XX大学",
      "major": "计算机科学与技术",
      "degree": "本科",
      "start_date": "2019-09",
      "end_date": "2023-06"
    },
    "job_expectations": {
      "position": "后端开发工程师",
      "location": "北京",
      "salary": "15k-20k"
    }
  },
  "history": [
    {"role": "ai", "content": "你好！让我们聊聊你的经历吧..."},
    {"role": "user", "content": "好的，我在校期间做过一个..."}
  ],
  "user_message": "这个项目主要是用 Python 开发的",
  "conversation_plan": {
    "stages": [
      {"stage": "开场破冰", "goal": "建立信任"},
      {"stage": "专业探索", "goal": "挖掘专业相关技能"}
    ]
  }
}
```

### 响应

```json
// 流式 SSE 响应，每行一个 JSON 对象

// 文本片段（多次）
data: {"type": "chunk", "content": "听起来很不错！"}

data: {"type": "chunk", "content": "能具体讲讲你在这个项目中..."}

// 文本结束
data: {"type": "DONE", "content": "[DONE]"}

// 对话计划（仅首次调用返回）
data: {"type": "plan", "content": {"stages": [...]}}

// 对话结束信号（满足结束条件时返回）
data: {"type": "over", "content": "over"}
```

---

## 5. 🔧 技术细节

### 状态管理

- **接口设计为无状态**：后端不存储会话状态
- **对话计划持久化**：采用前端透传方案
  - 首次调用：后端生成 `plan`，通过 SSE 返回给前端
  - 后续调用：前端将 `plan` 原样透传回后端
  - 优势：符合 KISS 原则，无需引入 Redis 等额外存储

### 流式响应

- 使用 FastAPI 的 `StreamingResponse`，媒体类型为 `text/event-stream`
- 响应头：
  ```python
  headers = {
      "Content-Type": "text/event-stream; charset=utf-8",
      "Cache-Control": "no-cache",
      "Connection": "keep-alive",
  }
  ```

### 沉默检测

- 检测最近 3 轮 user 消息是否有效
- 无效消息定义：空字符串、`"..."`、`"嗯"`、`"啊"` 等
- 连续 3 次无效 → 返回友好提示并结束对话

### AI 角色定位

- 扮演"长辈"或"职业培训师"
- 语气：**温和鼓励型**
- 目标：挖掘学生优点和潜力，而非评估能力

### 对话内容规划

对话计划包含以下阶段：
1. **开场破冰**：建立信任，了解基本情况
2. **专业探索**：挖掘专业相关的技能和收获
3. **经历挖掘**：发现项目/实习/社团等经历中的亮点
4. **案例分析**：通过场景判断思维模式（给出具体场景让学生分析）
5. **职业规划**：了解未来方向，收集求职意向
6. **收尾总结**：确认信息完整，友好结束

### 结束触发机制

- **非用户主动触发**：由 AI 自动判断信息是否收集完毕
- **前端识别**：前端监听 `{"type": "over"}` 事件
- **后续动作**：前端收到 `over` 后，可调用 `/resume/deep-optimization/generate` 接口生成简历

### 轮次限制

- **暂无限制**：为了充分挖掘信息，不设置对话轮次上限
- 结束由 AI 智能判断
